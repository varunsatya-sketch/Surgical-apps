<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OT Logbook">
    <meta name="theme-color" content="#667eea">
    <title>OT Logbook - Firebase</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23667eea;stop-opacity:1'/><stop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1'/></linearGradient></defs><rect width='180' height='180' fill='url(%23grad)'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='90' fill='white'>üè•</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-card h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 12px;
        }

        .login-card p {
            color: #718096;
            margin-bottom: 32px;
        }

        .google-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .google-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            color: white;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-details {
            flex: 1;
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header .stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .stat {
            background: #f7fafc;
            padding: 12px 16px;
            border-radius: 8px;
            flex: 1;
            min-width: 120px;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .case-list {
            margin-top: 20px;
        }

        .case-item {
            background: #f7fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .case-item:hover {
            background: #edf2f7;
            transform: translateX(4px);
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .case-procedure {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
            flex: 1;
        }

        .case-date {
            color: #718096;
            font-size: 13px;
            white-space: nowrap;
            margin-left: 12px;
        }

        .case-details {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
        }

        .case-detail-row {
            margin-bottom: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #718096;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-remove {
            background: #fc8181;
            color: white;
        }

        .btn-remove:hover {
            background: #f56565;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .error-message {
            background: #fc8181;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        @media (max-width: 640px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-card">
                <h1>üè• OT Logbook</h1>
                <p>Sign in to sync your surgical cases across all devices</p>
                <button class="google-btn" onclick="signInWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
                        <path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
                        <path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
                        <path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <!-- Sync Status & User Info -->
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <div class="user-details">
                    <div class="user-name" id="userName"></div>
                    <div class="user-email" id="userEmail"></div>
                </div>
                <button class="logout-btn" onclick="signOut()">Sign Out</button>
            </div>
            
            <div class="sync-status">
                <div class="sync-dot"></div>
                <span id="syncStatus">Synced</span>
            </div>

            <!-- Header with Stats -->
            <div class="header">
                <h1>OT Logbook</h1>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Total Cases</div>
                        <div class="stat-value" id="totalCases">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" id="monthCases">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">As Primary</div>
                        <div class="stat-value" id="primaryCases">0</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('add')">‚ûï Add Case</button>
                <button class="tab" onclick="switchTab('cases')">üìã Cases</button>
                <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>

            <!-- Add Case Tab -->
            <div id="addTab" class="content">
                <h2>Add Surgical Case</h2>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="caseDate" required>
                    </div>
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="startTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Duration (minutes) *</label>
                    <input type="number" id="duration" required min="1">
                </div>

                <div class="form-group">
                    <label>Procedure Name *</label>
                    <input type="text" id="procedureName" required>
                </div>

                <div class="form-group">
                    <label>Hospital</label>
                    <input type="text" id="hospital">
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label>Patient Name</label>
                        <input type="text" id="patientName">
                    </div>
                    <div class="form-group">
                        <label>Patient ID</label>
                        <input type="text" id="patientId">
                    </div>
                    <div class="form-group">
                        <label>Age</label>
                        <input type="number" id="patientAge" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Sex</label>
                        <select id="patientSex">
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Your Role *</label>
                        <select id="surgeonRole" required>
                            <option value="">Select</option>
                            <option value="Primary">Primary Surgeon</option>
                            <option value="Assistant">Assistant</option>
                            <option value="Observer">Observer</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Complications</label>
                    <textarea id="complications" placeholder="Any complications or notes..."></textarea>
                </div>

                <div id="customFieldsContainer"></div>

                <button class="btn btn-primary" onclick="saveCase()">üíæ Save Case</button>
                <button class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
            </div>

            <!-- Cases Tab -->
            <div id="casesTab" class="content" style="display: none;">
                <h2>My Surgical Cases</h2>
                
                <div class="form-group">
                    <input type="text" id="searchInput" placeholder="üîç Search procedures, hospitals, patient names...">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <select id="filterRole">
                            <option value="">All Roles</option>
                            <option value="Primary">Primary Surgeon</option>
                            <option value="Assistant">Assistant</option>
                            <option value="Observer">Observer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="filterDate">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>

                <div id="casesList" class="case-list"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="content" style="display: none;">
                <h2>Settings</h2>

                <h3 style="margin-bottom: 16px;">Custom Fields</h3>
                <div id="customFieldsList"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="newFieldName" placeholder="Enter field name">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addCustomField()">Add Field</button>
                    </div>
                </div>

                <h3 style="margin: 32px 0 16px;">Export Data</h3>
                <button class="btn btn-secondary" onclick="exportData()">üìä Export to CSV</button>
                <button class="btn btn-secondary" onclick="exportAllData()">üíæ Backup All Data (JSON)</button>

                <h3 style="margin: 32px 0 16px;">Import Data</h3>
                <button class="btn btn-secondary" onclick="importData()">üìÅ Import Backup</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">

                <h3 style="margin: 32px 0 16px;">Danger Zone</h3>
                <button class="btn btn-secondary btn-remove" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- Case Details Modal -->
    <div id="caseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Case Details</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-primary" onclick="editCase()" style="flex: 1;">Edit</button>
                <button class="btn btn-secondary btn-remove" onclick="deleteCase()" style="flex: 1;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQ8slJIJmDcSkpI0GuJU6GAZNuupY-mb4",
            authDomain: "surgical-tracker-fd4e4.firebaseapp.com",
            projectId: "surgical-tracker-fd4e4",
            storageBucket: "surgical-tracker-fd4e4.firebasestorage.app",
            messagingSenderId: "127110170150",
            appId: "1:127110170150:web:66567dbf2ea55af9ae88e7",
            measurementId: "G-CYEEBS48GK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        window.currentUser = null;
        window.cases = [];
        window.customFields = [];
        window.currentCaseId = null;
        window.editingCaseId = null;

        // Authentication
        window.signInWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed: ' + error.message);
            }
        };

        window.signOut = async function() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await firebaseSignOut(auth);
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            }
        };

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Update user info
                document.getElementById('userName').textContent = user.displayName || 'User';
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                
                // Load user data
                await loadUserData();
                
                // Set up real-time listeners
                setupRealtimeListeners();
            } else {
                window.currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        // Firestore operations
        async function loadUserData() {
            if (!window.currentUser) return;

            setSyncStatus('Syncing...', false);

            try {
                // Load custom fields
                const fieldsDoc = await getDoc(doc(db, 'users', window.currentUser.uid, 'settings', 'customFields'));
                if (fieldsDoc.exists()) {
                    window.customFields = fieldsDoc.data().fields || [];
                }

                // Load cases
                const casesSnapshot = await getDocs(collection(db, 'users', window.currentUser.uid, 'cases'));
                window.cases = casesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderCases();
                renderCustomFields();
                renderCustomFieldInputs();
                updateStats();
                setSyncStatus('Synced', true);
            } catch (error) {
                console.error('Error loading data:', error);
                setSyncStatus('Sync failed', false);
                showError('Failed to load data: ' + error.message);
            }
        }

        function setupRealtimeListeners() {
            if (!window.currentUser) return;

            // Listen to cases changes
            const casesQuery = query(collection(db, 'users', window.currentUser.uid, 'cases'));
            onSnapshot(casesQuery, (snapshot) => {
                window.cases = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderCases();
                updateStats();
            });

            // Listen to custom fields changes
            onSnapshot(doc(db, 'users', window.currentUser.uid, 'settings', 'customFields'), (doc) => {
                if (doc.exists()) {
                    window.customFields = doc.data().fields || [];
                    renderCustomFields();
                    renderCustomFieldInputs();
                }
            });
        }

        window.saveCase = async function() {
            if (!window.currentUser) {
                showError('You must be signed in to save cases');
                return;
            }

            const caseDate = document.getElementById('caseDate').value;
            const startTime = document.getElementById('startTime').value;
            const duration = document.getElementById('duration').value;
            const procedureName = document.getElementById('procedureName').value;
            const surgeonRole = document.getElementById('surgeonRole').value;

            if (!caseDate || !startTime || !duration || !procedureName || !surgeonRole) {
                showError('Please fill in all required fields');
                return;
            }

            const caseData = {
                date: caseDate,
                startTime: startTime,
                duration: parseInt(duration),
                procedureName: procedureName,
                hospital: document.getElementById('hospital').value,
                patientName: document.getElementById('patientName').value,
                patientId: document.getElementById('patientId').value,
                patientAge: document.getElementById('patientAge').value,
                patientSex: document.getElementById('patientSex').value,
                surgeonRole: surgeonRole,
                complications: document.getElementById('complications').value,
                customFields: {},
                updatedAt: serverTimestamp()
            };

            // Collect custom field values
            window.customFields.forEach(field => {
                const input = document.getElementById(`custom-${field.id}`);
                if (input) {
                    caseData.customFields[field.name] = input.value;
                }
            });

            setSyncStatus('Saving...', false);

            try {
                const caseId = window.editingCaseId || Date.now().toString();
                await setDoc(doc(db, 'users', window.currentUser.uid, 'cases', caseId), caseData);

                setSyncStatus('Synced', true);
                resetForm();
                switchTab('cases');
                
                if (window.editingCaseId) {
                    alert('‚úÖ Case updated successfully!');
                    window.editingCaseId = null;
                } else {
                    alert('‚úÖ Case saved successfully!');
                }
            } catch (error) {
                console.error('Error saving case:', error);
                setSyncStatus('Save failed', false);
                showError('Failed to save case: ' + error.message);
            }
        };

        window.deleteCase = async function() {
            if (!window.currentCaseId || !window.currentUser) return;
            
            if (confirm('Are you sure you want to delete this case? This cannot be undone.')) {
                setSyncStatus('Deleting...', false);
                
                try {
                    await deleteDoc(doc(db, 'users', window.currentUser.uid, 'cases', window.currentCaseId));
                    setSyncStatus('Synced', true);
                    closeModal();
                    alert('Case deleted successfully');
                } catch (error) {
                    console.error('Error deleting case:', error);
                    setSyncStatus('Delete failed', false);
                    showError('Failed to delete case: ' + error.message);
                }
            }
        };

        window.addCustomField = async function() {
            if (!window.currentUser) {
                showError('You must be signed in to add custom fields');
                return;
            }

            const fieldName = document.getElementById('newFieldName').value.trim();
            if (!fieldName) {
                alert('Please enter a field name');
                return;
            }

            window.customFields.push({
                id: Date.now(),
                name: fieldName
            });

            setSyncStatus('Saving...', false);

            try {
                await setDoc(doc(db, 'users', window.currentUser.uid, 'settings', 'customFields'), {
                    fields: window.customFields,
                    updatedAt: serverTimestamp()
                });

                setSyncStatus('Synced', true);
                document.getElementById('newFieldName').value = '';
            } catch (error) {
                console.error('Error saving custom field:', error);
                setSyncStatus('Save failed', false);
                showError('Failed to save custom field: ' + error.message);
            }
        };

        window.removeCustomField = async function(fieldId) {
            if (!window.currentUser) return;

            if (confirm('Remove this custom field? Data in existing cases will be preserved.')) {
                window.customFields = window.customFields.filter(f => f.id !== fieldId);
                
                setSyncStatus('Saving...', false);

                try {
                    await setDoc(doc(db, 'users', window.currentUser.uid, 'settings', 'customFields'), {
                        fields: window.customFields,
                        updatedAt: serverTimestamp()
                    });

                    setSyncStatus('Synced', true);
                } catch (error) {
                    console.error('Error removing custom field:', error);
                    setSyncStatus('Save failed', false);
                    showError('Failed to remove custom field: ' + error.message);
                }
            }
        };

        window.clearAllData = async function() {
            if (!window.currentUser) return;

            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL your cases and custom fields from the cloud. This cannot be undone. Are you sure?')) {
                if (confirm('Final confirmation: Delete everything?')) {
                    setSyncStatus('Deleting...', false);

                    try {
                        // Delete all cases
                        const casesSnapshot = await getDocs(collection(db, 'users', window.currentUser.uid, 'cases'));
                        const deletePromises = casesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);

                        // Delete custom fields
                        await deleteDoc(doc(db, 'users', window.currentUser.uid, 'settings', 'customFields'));

                        setSyncStatus('Synced', true);
                        alert('All data cleared');
                    } catch (error) {
                        console.error('Error clearing data:', error);
                        setSyncStatus('Delete failed', false);
                        showError('Failed to clear data: ' + error.message);
                    }
                }
            }
        };

        // UI Helper Functions
        function setSyncStatus(message, success) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            const dot = document.querySelector('.sync-dot');
            if (success) {
                dot.style.background = '#48bb78';
            } else {
                dot.style.background = '#fc8181';
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        // UI Rendering Functions
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.style.display = 'none');

            if (tab === 'add') {
                event.target.classList.add('active');
                document.getElementById('addTab').style.display = 'block';
            } else if (tab === 'cases') {
                event.target.classList.add('active');
                document.getElementById('casesTab').style.display = 'block';
                renderCases();
            } else if (tab === 'settings') {
                event.target.classList.add('active');
                document.getElementById('settingsTab').style.display = 'block';
            }
        };

        window.renderCases = function() {
            const list = document.getElementById('casesList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const dateFilter = document.getElementById('filterDate').value;

            let filtered = window.cases.filter(c => {
                const matchesSearch = c.procedureName.toLowerCase().includes(searchTerm) ||
                    (c.hospital && c.hospital.toLowerCase().includes(searchTerm)) ||
                    (c.patientName && c.patientName.toLowerCase().includes(searchTerm));
                
                const matchesRole = !roleFilter || c.surgeonRole === roleFilter;

                let matchesDate = true;
                if (dateFilter !== 'all') {
                    const caseDate = new Date(c.date);
                    const now = new Date();
                    
                    if (dateFilter === 'today') {
                        matchesDate = caseDate.toDateString() === now.toDateString();
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchesDate = caseDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        matchesDate = caseDate.getMonth() === now.getMonth() && 
                                     caseDate.getFullYear() === now.getFullYear();
                    }
                }

                return matchesSearch && matchesRole && matchesDate;
            });

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No cases found</p>';
                return;
            }

            list.innerHTML = filtered.map(c => `
                <div class="case-item" onclick="showCaseDetails('${c.id}')">
                    <div class="case-header">
                        <div class="case-procedure">${c.procedureName}</div>
                        <div class="case-date">${formatDate(c.date)}</div>
                    </div>
                    <div class="case-details">
                        <div class="case-detail-row">üè• ${c.hospital || 'N/A'} ‚Ä¢ üë®‚Äç‚öïÔ∏è ${c.surgeonRole}</div>
                        <div class="case-detail-row">‚è±Ô∏è ${c.duration} mins ‚Ä¢ üïê ${c.startTime}</div>
                        ${c.patientName ? `<div class="case-detail-row">üë§ ${c.patientName}${c.patientAge ? `, ${c.patientAge}y` : ''}</div>` : ''}
                    </div>
                </div>
            `).join('');
        };

        window.showCaseDetails = function(caseId) {
            window.currentCaseId = caseId;
            const caseData = window.cases.find(c => c.id === caseId);
            if (!caseData) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div style="line-height: 1.8;">
                    <p><strong>üìÖ Date:</strong> ${formatDate(caseData.date)}</p>
                    <p><strong>üïê Start Time:</strong> ${caseData.startTime}</p>
                    <p><strong>‚è±Ô∏è Duration:</strong> ${caseData.duration} minutes</p>
                    <p><strong>üè• Hospital:</strong> ${caseData.hospital || 'N/A'}</p>
                    <p><strong>üë®‚Äç‚öïÔ∏è Your Role:</strong> ${caseData.surgeonRole}</p>
                    ${caseData.patientName ? `<p><strong>üë§ Patient:</strong> ${caseData.patientName}</p>` : ''}
                    ${caseData.patientId ? `<p><strong>üÜî Patient ID:</strong> ${caseData.patientId}</p>` : ''}
                    ${caseData.patientAge ? `<p><strong>üë∂ Age:</strong> ${caseData.patientAge}</p>` : ''}
                    ${caseData.patientSex ? `<p><strong>‚öß Sex:</strong> ${caseData.patientSex}</p>` : ''}
                    ${caseData.complications ? `<p><strong>‚ö†Ô∏è Complications:</strong> ${caseData.complications}</p>` : ''}
                    ${Object.keys(caseData.customFields || {}).map(key => 
                        `<p><strong>${key}:</strong> ${caseData.customFields[key]}</p>`
                    ).join('')}
                </div>
            `;

            document.getElementById('caseModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('caseModal').classList.remove('active');
            window.currentCaseId = null;
        };

        window.editCase = function() {
            if (!window.currentCaseId) return;
            
            const caseData = window.cases.find(c => c.id === window.currentCaseId);
            if (!caseData) return;

            window.editingCaseId = window.currentCaseId;

            document.getElementById('caseDate').value = caseData.date;
            document.getElementById('startTime').value = caseData.startTime;
            document.getElementById('duration').value = caseData.duration;
            document.getElementById('procedureName').value = caseData.procedureName;
            document.getElementById('hospital').value = caseData.hospital || '';
            document.getElementById('patientName').value = caseData.patientName || '';
            document.getElementById('patientId').value = caseData.patientId || '';
            document.getElementById('patientAge').value = caseData.patientAge || '';
            document.getElementById('patientSex').value = caseData.patientSex || '';
            document.getElementById('surgeonRole').value = caseData.surgeonRole;
            document.getElementById('complications').value = caseData.complications || '';

            window.customFields.forEach(field => {
                const input = document.getElementById(`custom-${field.id}`);
                if (input && caseData.customFields) {
                    input.value = caseData.customFields[field.name] || '';
                }
            });

            document.querySelector('#addTab h2').textContent = 'Edit Surgical Case';

            closeModal();
            switchTab('add');
        };

        window.renderCustomFields = function() {
            const container = document.getElementById('customFieldsList');
            
            if (window.customFields.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-style: italic;">No custom fields added yet.</p>';
                return;
            }

            container.innerHTML = window.customFields.map(field => `
                <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center;">
                    <input type="text" value="${field.name}" readonly style="flex: 1; background: #f7fafc; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <button class="btn btn-small btn-remove" onclick="removeCustomField(${field.id})">Remove</button>
                </div>
            `).join('');
        };

        window.renderCustomFieldInputs = function() {
            const container = document.getElementById('customFieldsContainer');
            
            if (window.customFields.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
                    <h3 style="margin-bottom: 16px; color: #2d3748;">Custom Fields</h3>
                    ${window.customFields.map(field => `
                        <div class="form-group">
                            <label>${field.name}</label>
                            <input type="text" id="custom-${field.id}">
                        </div>
                    `).join('')}
                </div>
            `;
        };

        window.updateStats = function() {
            const total = window.cases.length;
            const now = new Date();
            const thisMonth = window.cases.filter(c => {
                const caseDate = new Date(c.date);
                return caseDate.getMonth() === now.getMonth() && 
                       caseDate.getFullYear() === now.getFullYear();
            }).length;
            const primary = window.cases.filter(c => c.surgeonRole === 'Primary').length;

            document.getElementById('totalCases').textContent = total;
            document.getElementById('monthCases').textContent = thisMonth;
            document.getElementById('primaryCases').textContent = primary;
        };

        window.resetForm = function() {
            document.getElementById('caseDate').value = '';
            document.getElementById('startTime').value = '';
            document.getElementById('duration').value = '';
            document.getElementById('procedureName').value = '';
            document.getElementById('hospital').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('patientId').value = '';
            document.getElementById('patientAge').value = '';
            document.getElementById('patientSex').value = '';
            document.getElementById('surgeonRole').value = '';
            document.getElementById('complications').value = '';

            window.customFields.forEach(field => {
                const input = document.getElementById(`custom-${field.id}`);
                if (input) input.value = '';
            });

            window.editingCaseId = null;
            document.querySelector('#addTab h2').textContent = 'Add Surgical Case';
        };

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // Export functions
        window.exportData = function() {
            if (window.cases.length === 0) {
                alert('No cases to export');
                return;
            }

            const headers = [
                'Date', 'Start Time', 'Duration (mins)', 'Procedure', 'Hospital',
                'Patient Name', 'Patient ID', 'Age', 'Sex', 'Surgeon Role', 'Complications'
            ];

            const customFieldNames = window.customFields.map(f => f.name);
            const allHeaders = [...headers, ...customFieldNames];

            const rows = window.cases.map(c => {
                const baseData = [
                    c.date, c.startTime, c.duration, c.procedureName, c.hospital || '',
                    c.patientName || '', c.patientId || '', c.patientAge || '',
                    c.patientSex || '', c.surgeonRole, c.complications || ''
                ];

                const customData = customFieldNames.map(name => c.customFields?.[name] || '');
                return [...baseData, ...customData];
            });

            let csv = allHeaders.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            downloadFile(csv, `ot-logbook-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        };

        window.exportAllData = function() {
            const backup = {
                cases: window.cases,
                customFields: window.customFields,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(backup, null, 2);
            downloadFile(json, `ot-logbook-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            alert('‚úÖ Complete backup downloaded!');
        };

        window.importData = function() {
            document.getElementById('fileInput').click();
        };

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (confirm('This will merge with your current cloud data. Continue?')) {
                        setSyncStatus('Importing...', false);

                        // Import cases
                        for (const caseData of backup.cases || []) {
                            const caseId = caseData.id || Date.now().toString() + Math.random();
                            await setDoc(doc(db, 'users', window.currentUser.uid, 'cases', caseId), {
                                ...caseData,
                                updatedAt: serverTimestamp()
                            });
                        }

                        // Import custom fields
                        if (backup.customFields && backup.customFields.length > 0) {
                            await setDoc(doc(db, 'users', window.currentUser.uid, 'settings', 'customFields'), {
                                fields: backup.customFields,
                                updatedAt: serverTimestamp()
                            });
                        }

                        setSyncStatus('Synced', true);
                        alert('‚úÖ Data imported successfully!');
                    }
                } catch (error) {
                    console.error('Error importing data:', error);
                    showError('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            this.value = '';
        });

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderCases);
        document.getElementById('filterRole').addEventListener('change', renderCases);
        document.getElementById('filterDate').addEventListener('change', renderCases);

        document.getElementById('caseModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Set today's date as default
        document.getElementById('caseDate').valueAsDate = new Date();
    </script>
</body>
</html>
