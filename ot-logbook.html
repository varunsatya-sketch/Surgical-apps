<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OT Logbook">
    <meta name="theme-color" content="#667eea">
    <title>OT Logbook</title>
    
    <!-- App Icon for Home Screen -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23667eea;stop-opacity:1'/><stop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1'/></linearGradient></defs><rect width='180' height='180' fill='url(%23grad)'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='90' fill='white'>üè•</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header .stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .stat {
            background: #f7fafc;
            padding: 12px 16px;
            border-radius: 8px;
            flex: 1;
            min-width: 120px;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .case-list {
            margin-top: 20px;
        }

        .case-item {
            background: #f7fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .case-item:hover {
            background: #edf2f7;
            transform: translateX(4px);
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .case-procedure {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
            flex: 1;
        }

        .case-date {
            color: #718096;
            font-size: 13px;
            white-space: nowrap;
            margin-left: 12px;
        }

        .case-details {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
        }

        .case-detail-row {
            margin-bottom: 4px;
        }

        .custom-fields {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #e2e8f0;
        }

        .custom-field-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .custom-field-item input {
            flex: 1;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add {
            background: #48bb78;
            color: white;
        }

        .btn-remove {
            background: #f56565;
            color: white;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        @media (max-width: 640px) {
            .form-row,
            .form-row-3,
            .filter-row {
                grid-template-columns: 1fr;
            }

            .header .stats {
                flex-direction: column;
            }

            .stat {
                min-width: 100%;
            }
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-primary {
            background: #bee3f8;
            color: #2c5282;
        }

        .badge-assistant {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-complication {
            background: #fed7d7;
            color: #742a2a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• OT Logbook</h1>
            <p style="color: #718096; margin-top: 4px;">Surgical Case Management</p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Total Cases</div>
                    <div class="stat-value" id="totalCases">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">This Month</div>
                    <div class="stat-value" id="monthCases">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">As Primary</div>
                    <div class="stat-value" id="primaryCases">0</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">Add Case</button>
            <button class="tab" onclick="switchTab('view')">View Cases</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Add Case Tab -->
        <div class="content" id="addTab">
            <h2 style="margin-bottom: 20px; color: #2d3748;">New Surgical Case</h2>
            <form id="caseForm">
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="caseDate" required>
                    </div>
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="startTime" required>
                    </div>
                    <div class="form-group">
                        <label>Duration (mins) *</label>
                        <input type="number" id="duration" min="1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Procedure Type/Name *</label>
                    <input type="text" id="procedureName" placeholder="e.g., Laparoscopic Cholecystectomy" required>
                </div>

                <div class="form-group">
                    <label>Diagnosis</label>
                    <input type="text" id="diagnosis" placeholder="e.g., Cholelithiasis, Carcinoma, etc.">
                </div>

                <div class="form-group">
                    <label>Patient Name</label>
                    <input type="text" id="patientName" placeholder="Patient's name (optional)">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Patient ID</label>
                        <input type="text" id="patientId" placeholder="Hospital ID">
                    </div>
                    <div class="form-group">
                        <label>Age</label>
                        <input type="number" id="patientAge" min="0" max="120">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Hospital *</label>
                        <select id="hospital" required onchange="toggleOtherHospital()">
                            <option value="">Select Hospital</option>
                            <option value="MH">MH</option>
                            <option value="MTH">MTH</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="otherHospitalGroup" style="display: none;">
                        <label>Hospital Name</label>
                        <input type="text" id="otherHospital" placeholder="Enter hospital name">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Sex</label>
                        <select id="patientSex">
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Surgeon Role *</label>
                        <select id="surgeonRole" required>
                            <option value="">Select</option>
                            <option value="Primary">Primary Surgeon</option>
                            <option value="Assistant">Assistant</option>
                            <option value="Observer">Observer</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Complications / Special Events</label>
                    <textarea id="complications" placeholder="Record any intraoperative complications, unexpected findings, or special events..."></textarea>
                </div>

                <div class="form-group">
                    <label>Intraoperative Images (Max 3)</label>
                    <input type="file" id="intraopImages" accept="image/*" multiple style="padding: 8px;">
                    <p style="font-size: 12px; color: #718096; margin-top: 8px;">Images will be automatically compressed. Max 3 images per case.</p>
                    <div id="imagePreview" style="display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap;"></div>
                </div>

                <div class="custom-fields" id="customFieldsForm">
                    <h3 style="margin-bottom: 16px; color: #2d3748;">Custom Fields</h3>
                    <div id="customFieldInputs"></div>
                </div>

                <button type="submit" class="btn btn-primary">Save Case</button>
            </form>
        </div>

        <!-- View Cases Tab -->
        <div class="content" id="viewTab" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Case History</h2>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search by procedure, patient ID, or notes...">
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Filter by Role</label>
                        <select id="filterRole">
                            <option value="">All Roles</option>
                            <option value="Primary">Primary Surgeon</option>
                            <option value="Assistant">Assistant</option>
                            <option value="Observer">Observer</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Date Range</label>
                        <select id="filterDate">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="case-list" id="caseList"></div>

            <div class="export-section">
                <button class="btn btn-secondary" onclick="exportData()">üìä Export All Data (CSV)</button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="content" id="settingsTab" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Settings</h2>
            
            <div style="background: #f0f4ff; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="color: #2d3748; margin-bottom: 12px;">‚òÅÔ∏è Cloud Backup</h3>
                <p style="color: #4a5568; margin-bottom: 16px; line-height: 1.6;">
                    Your data is automatically backed up online. You can access it from any device by opening this app.
                    Data is private and stored securely.
                </p>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-small" onclick="manualBackup()" style="background: #4299e1; color: white; flex: 1;">üíæ Backup Now</button>
                    <button class="btn-small" onclick="restoreFromBackup()" style="background: #9f7aea; color: white; flex: 1;">üîÑ Restore Data</button>
                </div>
                <p id="backupStatus" style="margin-top: 12px; font-size: 13px; color: #718096;"></p>
            </div>

            <div style="margin-bottom: 24px;">
                <h3 style="color: #2d3748; margin-bottom: 12px;">Custom Fields Configuration</h3>
                <p style="color: #718096; margin-bottom: 16px;">Add custom fields to track additional information for each surgical case.</p>

                <div id="customFieldsList"></div>

                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <input type="text" id="newFieldName" placeholder="Field name (e.g., Anesthesia Type)" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <button class="btn-small btn-add" onclick="addCustomField()">+ Add Field</button>
                </div>
            </div>

            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <h3 style="color: #2d3748; margin-bottom: 12px;">Data Management</h3>
                <button class="btn btn-secondary" onclick="exportAllData()" style="background: #4299e1; color: white; margin-bottom: 12px;">üíæ Download Complete Backup (JSON)</button>
                <button class="btn btn-secondary" onclick="importData()" style="background: #9f7aea; color: white; margin-bottom: 12px;">üì§ Import Data from File</button>
                <button class="btn btn-secondary" onclick="clearAllData()" style="background: #fed7d7; color: #742a2a;">üóëÔ∏è Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- Case Details Modal -->
    <div class="modal" id="caseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Case Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
            <button class="btn btn-secondary" onclick="editCase()" style="background: #4299e1; color: white; margin-top: 20px;">‚úèÔ∏è Edit Case</button>
            <button class="btn btn-secondary" onclick="deleteCase()" style="background: #fed7d7; color: #742a2a; margin-top: 12px;">Delete Case</button>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        let cases = [];
        let customFields = [];
        let currentCaseId = null;
        let editMode = false;
        let editingCaseId = null;

        // Initialize
        async function init() {
            // Get user identity
            await getUserIdentity();
            
            await loadData();
            renderCustomFields();
            renderCustomFieldInputs();
            renderCases();
            updateStats();
            
            // Set today's date as default
            document.getElementById('caseDate').valueAsDate = new Date();

            // Show last backup time
            showBackupStatus();
        }

        // Toggle other hospital input
        function toggleOtherHospital() {
            const hospitalSelect = document.getElementById('hospital');
            const otherGroup = document.getElementById('otherHospitalGroup');
            const otherInput = document.getElementById('otherHospital');
            
            if (hospitalSelect.value === 'Other') {
                otherGroup.style.display = 'block';
                otherInput.required = true;
            } else {
                otherGroup.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        // Get or set user identity
        async function getUserIdentity() {
            try {
                const result = await window.storage.get('current-user-ot', false);
                if (result && result.value) {
                    currentUser = result.value;
                } else {
                    const name = prompt('Please enter your name (for tracking who makes entries):');
                    if (name && name.trim()) {
                        currentUser = name.trim();
                        await window.storage.set('current-user-ot', currentUser, false);
                    } else {
                        currentUser = 'Unknown User';
                    }
                }
                
                // Check if admin
                try {
                    const adminResult = await window.storage.get('is-admin-ot', false);
                    isAdmin = adminResult && adminResult.value === 'true';
                } catch (e) {
                    isAdmin = false;
                }
                
                // Display current user in settings
                const display = document.getElementById('currentUserDisplay');
                if (display) {
                    display.textContent = currentUser + (isAdmin ? ' (Admin)' : '');
                }
            } catch (e) {
                currentUser = 'Unknown User';
                isAdmin = false;
            }
        }

        // Toggle admin mode
        async function toggleAdmin() {
            if (isAdmin) {
                // Logout from admin
                if (confirm('Logout from admin mode?')) {
                    isAdmin = false;
                    await window.storage.set('is-admin-ot', 'false', false);
                    document.getElementById('currentUserDisplay').textContent = currentUser;
                    document.getElementById('adminToggleBtn').textContent = 'üîê Login as Admin';
                    alert('‚úÖ Logged out from admin mode');
                }
            } else {
                // Login as admin
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    await window.storage.set('is-admin-ot', 'true', false);
                    document.getElementById('currentUserDisplay').textContent = currentUser + ' (Admin)';
                    document.getElementById('adminToggleBtn').textContent = 'üîì Logout from Admin';
                    alert('‚úÖ Admin access granted! You can now see edit history and user details.');
                } else if (password !== null) {
                    alert('‚ùå Incorrect password');
                }
            }
        }

        // Change username
        async function changeUsername() {
            const newName = prompt('Enter new username:', currentUser);
            if (newName && newName.trim() && newName.trim() !== currentUser) {
                currentUser = newName.trim();
                await window.storage.set('current-user-ot', currentUser, false);
                document.getElementById('currentUserDisplay').textContent = currentUser;
                alert('‚úÖ Username updated to: ' + currentUser);
            }
        }

        // Image handling
        document.getElementById('intraopImages').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files).slice(0, 3); // Max 3 images
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            for (let file of files) {
                const compressed = await compressImage(file);
                const img = document.createElement('img');
                img.src = compressed;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                img.style.border = '2px solid #e2e8f0';
                preview.appendChild(img);
            }
        });

        // Compress image to base64
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Max dimension 800px
                        const maxSize = 800;
                        if (width > height && width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        } else if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to 0.7 quality JPEG
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Get compressed images from file input
        async function getCompressedImages() {
            const files = Array.from(document.getElementById('intraopImages').files).slice(0, 3);
            const images = [];
            for (let file of files) {
                const compressed = await compressImage(file);
                images.push(compressed);
            }
            return images;
        }

        // Load data from storage
        async function loadData() {
            try {
                const casesResult = await window.storage.get('ot-cases', false);
                if (casesResult) {
                    cases = JSON.parse(casesResult.value);
                }
            } catch (e) {
                cases = [];
            }

            try {
                const fieldsResult = await window.storage.get('custom-fields', false);
                if (fieldsResult) {
                    customFields = JSON.parse(fieldsResult.value);
                }
            } catch (e) {
                customFields = [];
            }
        }

        // Save data to storage
        async function saveData() {
            try {
                await window.storage.set('ot-cases', JSON.stringify(cases), false);
                await window.storage.set('custom-fields', JSON.stringify(customFields), false);
                await window.storage.set('last-backup-ot', new Date().toISOString(), false);
                showBackupStatus();
            } catch (e) {
                alert('Error saving data: ' + e.message);
            }
        }

        // Manual backup
        async function manualBackup() {
            await saveData();
            alert('‚úÖ Data backed up successfully!');
        }

        // Restore from backup
        async function restoreFromBackup() {
            if (confirm('This will replace your current data with the backed up version. Continue?')) {
                await loadData();
                renderCases();
                renderCustomFields();
                renderCustomFieldInputs();
                updateStats();
                alert('‚úÖ Data restored from backup!');
            }
        }

        // Show backup status
        async function showBackupStatus() {
            try {
                const result = await window.storage.get('last-backup-ot', false);
                if (result) {
                    const date = new Date(result.value);
                    document.getElementById('backupStatus').textContent = 
                        `Last backup: ${date.toLocaleString()}`;
                }
            } catch (e) {
                document.getElementById('backupStatus').textContent = 'No backup found';
            }
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.style.display = 'none');

            if (tab === 'add') {
                event.target.classList.add('active');
                document.getElementById('addTab').style.display = 'block';
            } else if (tab === 'view') {
                event.target.classList.add('active');
                document.getElementById('viewTab').style.display = 'block';
                renderCases();
            } else if (tab === 'settings') {
                event.target.classList.add('active');
                document.getElementById('settingsTab').style.display = 'block';
                renderCustomFields();
            }
        }

        // Handle form submission
        document.getElementById('caseForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const customFieldData = {};
            customFields.forEach(field => {
                const input = document.getElementById(`custom-${field.id}`);
                if (input) {
                    customFieldData[field.name] = input.value;
                }
            });

            // Get compressed images (or keep existing ones if editing and no new images)
            let images = [];
            if (document.getElementById('intraopImages').files.length > 0) {
                images = await getCompressedImages();
            } else if (editMode) {
                const existingCase = cases.find(c => c.id === editingCaseId);
                images = existingCase.images || [];
            }

            const now = new Date().toISOString();

            // Determine hospital name
            const hospitalValue = document.getElementById('hospital').value;
            const hospitalName = hospitalValue === 'Other' 
                ? document.getElementById('otherHospital').value 
                : hospitalValue;

            const caseData = {
                id: editMode ? editingCaseId : Date.now(),
                date: document.getElementById('caseDate').value,
                startTime: document.getElementById('startTime').value,
                duration: parseInt(document.getElementById('duration').value),
                procedureName: document.getElementById('procedureName').value,
                diagnosis: document.getElementById('diagnosis').value,
                patientName: document.getElementById('patientName').value,
                patientId: document.getElementById('patientId').value,
                hospital: hospitalName,
                patientAge: document.getElementById('patientAge').value,
                patientSex: document.getElementById('patientSex').value,
                surgeonRole: document.getElementById('surgeonRole').value,
                complications: document.getElementById('complications').value,
                images: images,
                customFields: customFieldData,
                createdAt: editMode ? cases.find(c => c.id === editingCaseId).createdAt : now,
                lastModified: now
            };

            if (editMode) {
                // Update existing case
                const index = cases.findIndex(c => c.id === editingCaseId);
                cases[index] = caseData;
                editMode = false;
                editingCaseId = null;
                document.querySelector('#addTab h2').textContent = 'New Surgical Case';
            } else {
                // Add new case
                cases.unshift(caseData);
            }

            await saveData();

            // Reset form
            this.reset();
            document.getElementById('caseDate').valueAsDate = new Date();
            document.getElementById('imagePreview').innerHTML = '';
            renderCustomFieldInputs();

            updateStats();
            alert(editMode ? '‚úÖ Case updated successfully!' : '‚úÖ Case saved successfully!');
            
            // Switch to view tab
            switchTab('view');
        });

        // Render custom field inputs in form
        function renderCustomFieldInputs() {
            const container = document.getElementById('customFieldInputs');
            if (customFields.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-style: italic;">No custom fields configured. Add them in Settings.</p>';
                return;
            }

            container.innerHTML = customFields.map(field => `
                <div class="form-group">
                    <label>${field.name}</label>
                    <input type="text" id="custom-${field.id}" placeholder="Enter ${field.name}">
                </div>
            `).join('');
        }

        // Render cases list
        function renderCases() {
            const container = document.getElementById('caseList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterRole = document.getElementById('filterRole').value;
            const filterDate = document.getElementById('filterDate').value;

            let filtered = cases.filter(c => {
                const matchesSearch = !searchTerm || 
                    c.procedureName.toLowerCase().includes(searchTerm) ||
                    c.patientId.toLowerCase().includes(searchTerm) ||
                    c.complications.toLowerCase().includes(searchTerm);

                const matchesRole = !filterRole || c.surgeonRole === filterRole;

                let matchesDate = true;
                if (filterDate) {
                    const caseDate = new Date(c.date);
                    const now = new Date();
                    
                    if (filterDate === 'today') {
                        matchesDate = caseDate.toDateString() === now.toDateString();
                    } else if (filterDate === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchesDate = caseDate >= weekAgo;
                    } else if (filterDate === 'month') {
                        matchesDate = caseDate.getMonth() === now.getMonth() && 
                                     caseDate.getFullYear() === now.getFullYear();
                    } else if (filterDate === 'year') {
                        matchesDate = caseDate.getFullYear() === now.getFullYear();
                    }
                }

                return matchesSearch && matchesRole && matchesDate;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No cases found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(c => {
                const roleBadge = c.surgeonRole === 'Primary' ? 'badge-primary' : 'badge-assistant';
                const hasComplications = c.complications && c.complications.trim() !== '';
                
                return `
                    <div class="case-item" onclick="showCaseDetails(${c.id})">
                        <div class="case-header">
                            <div class="case-procedure">${c.procedureName}</div>
                            <div class="case-date">${formatDate(c.date)}</div>
                        </div>
                        <div class="case-details">
                            <div class="case-detail-row">
                                <span class="badge ${roleBadge}">${c.surgeonRole}</span>
                                ${hasComplications ? '<span class="badge badge-complication">Complication</span>' : ''}
                            </div>
                            <div class="case-detail-row">
                                <strong>Patient:</strong> ${c.patientName || ''} ${c.patientName && c.patientId ? '(' + c.patientId + ')' : c.patientId || 'N/A'} | 
                                <strong>Age:</strong> ${c.patientAge || 'N/A'} | 
                                <strong>Sex:</strong> ${c.patientSex || 'N/A'}
                            </div>
                            <div class="case-detail-row">
                                <strong>Time:</strong> ${c.startTime} | <strong>Duration:</strong> ${c.duration} mins
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show case details modal
        function showCaseDetails(caseId) {
            currentCaseId = caseId;
            const caseData = cases.find(c => c.id === caseId);
            if (!caseData) return;

            const customFieldsHtml = Object.keys(caseData.customFields || {}).length > 0 
                ? `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h3 style="margin-bottom: 12px; color: #2d3748;">Custom Fields</h3>
                        ${Object.entries(caseData.customFields).map(([key, value]) => `
                            <div style="margin-bottom: 12px;">
                                <strong>${key}:</strong> ${value || 'N/A'}
                            </div>
                        `).join('')}
                    </div>
                `
                : '';

            const imagesHtml = caseData.images && caseData.images.length > 0
                ? `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h3 style="margin-bottom: 12px; color: #2d3748;">Intraoperative Images</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${caseData.images.map(img => `
                                <img src="${img}" onclick="window.open(this.src)" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e2e8f0;" title="Click to view full size">
                            `).join('')}
                        </div>
                    </div>
                `
                : '';

            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #667eea; margin-bottom: 8px;">${caseData.procedureName}</h3>
                    <p style="color: #718096;">${formatDate(caseData.date)} at ${caseData.startTime}</p>
                </div>

                <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    ${caseData.hospital ? `<div style="margin-bottom: 8px;"><strong>Hospital:</strong> ${caseData.hospital}</div>` : ''}
                    ${caseData.diagnosis ? `<div style="margin-bottom: 8px;"><strong>Diagnosis:</strong> ${caseData.diagnosis}</div>` : ''}
                    ${caseData.patientName ? `<div style="margin-bottom: 8px;"><strong>Patient Name:</strong> ${caseData.patientName}</div>` : ''}
                    <div style="margin-bottom: 8px;"><strong>Patient ID:</strong> ${caseData.patientId || 'N/A'}</div>
                    <div style="margin-bottom: 8px;"><strong>Age:</strong> ${caseData.patientAge || 'N/A'}</div>
                    <div style="margin-bottom: 8px;"><strong>Sex:</strong> ${caseData.patientSex || 'N/A'}</div>
                    <div style="margin-bottom: 8px;"><strong>Duration:</strong> ${caseData.duration} minutes</div>
                    <div><strong>Role:</strong> ${caseData.surgeonRole}</div>
                </div>

                ${caseData.complications ? `
                    <div style="margin-bottom: 16px;">
                        <strong style="color: #2d3748;">Complications / Special Events:</strong>
                        <p style="margin-top: 8px; color: #4a5568; line-height: 1.6;">${caseData.complications}</p>
                    </div>
                ` : ''}

                ${imagesHtml}
                ${customFieldsHtml}
            `;

            document.getElementById('caseModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('caseModal').classList.remove('active');
            currentCaseId = null;
        }

        function editCase() {
            if (!currentCaseId) return;
            
            const caseData = cases.find(c => c.id === currentCaseId);
            if (!caseData) return;

            // Enter edit mode
            editMode = true;
            editingCaseId = currentCaseId;

            // Populate form
            document.getElementById('caseDate').value = caseData.date;
            document.getElementById('startTime').value = caseData.startTime;
            document.getElementById('duration').value = caseData.duration;
            document.getElementById('procedureName').value = caseData.procedureName;
            document.getElementById('diagnosis').value = caseData.diagnosis || '';
            document.getElementById('patientName').value = caseData.patientName || '';
            document.getElementById('patientId').value = caseData.patientId || '';
            
            // Set hospital
            const isCustomHospital = caseData.hospital && !['MH', 'MTH'].includes(caseData.hospital);
            if (isCustomHospital) {
                document.getElementById('hospital').value = 'Other';
                document.getElementById('otherHospital').value = caseData.hospital;
                toggleOtherHospital();
            } else {
                document.getElementById('hospital').value = caseData.hospital || '';
            }
            
            document.getElementById('patientAge').value = caseData.patientAge || '';
            document.getElementById('patientSex').value = caseData.patientSex || '';
            document.getElementById('surgeonRole').value = caseData.surgeonRole;
            document.getElementById('complications').value = caseData.complications || '';

            // Show existing images in preview
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            if (caseData.images && caseData.images.length > 0) {
                caseData.images.forEach(img => {
                    const imgEl = document.createElement('img');
                    imgEl.src = img;
                    imgEl.style.width = '100px';
                    imgEl.style.height = '100px';
                    imgEl.style.objectFit = 'cover';
                    imgEl.style.borderRadius = '8px';
                    imgEl.style.border = '2px solid #e2e8f0';
                    preview.appendChild(imgEl);
                });
            }

            // Populate custom fields
            customFields.forEach(field => {
                const input = document.getElementById(`custom-${field.id}`);
                if (input && caseData.customFields) {
                    input.value = caseData.customFields[field.name] || '';
                }
            });

            // Update form title
            document.querySelector('#addTab h2').textContent = 'Edit Surgical Case';

            // Close modal and switch to add tab
            closeModal();
            switchTab('add');
        }

        async function deleteCase() {
            if (!currentCaseId) return;
            
            if (confirm('Are you sure you want to delete this case? This cannot be undone.')) {
                cases = cases.filter(c => c.id !== currentCaseId);
                await saveData();
                closeModal();
                renderCases();
                updateStats();
            }
        }

        // Custom fields management
        function renderCustomFields() {
            const container = document.getElementById('customFieldsList');
            
            if (customFields.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-style: italic;">No custom fields added yet.</p>';
                return;
            }

            container.innerHTML = customFields.map(field => `
                <div class="custom-field-item">
                    <input type="text" value="${field.name}" readonly style="background: #f7fafc;">
                    <button class="btn-small btn-remove" onclick="removeCustomField(${field.id})">Remove</button>
                </div>
            `).join('');
        }

        async function addCustomField() {
            const fieldName = document.getElementById('newFieldName').value.trim();
            if (!fieldName) {
                alert('Please enter a field name');
                return;
            }

            customFields.push({
                id: Date.now(),
                name: fieldName
            });

            await saveData();
            document.getElementById('newFieldName').value = '';
            renderCustomFields();
            renderCustomFieldInputs();
        }

        async function removeCustomField(fieldId) {
            if (confirm('Remove this custom field? Data in existing cases will be preserved.')) {
                customFields = customFields.filter(f => f.id !== fieldId);
                await saveData();
                renderCustomFields();
                renderCustomFieldInputs();
            }
        }

        // Statistics
        function updateStats() {
            const total = cases.length;
            const now = new Date();
            const thisMonth = cases.filter(c => {
                const caseDate = new Date(c.date);
                return caseDate.getMonth() === now.getMonth() && 
                       caseDate.getFullYear() === now.getFullYear();
            }).length;
            const primary = cases.filter(c => c.surgeonRole === 'Primary').length;

            document.getElementById('totalCases').textContent = total;
            document.getElementById('monthCases').textContent = thisMonth;
            document.getElementById('primaryCases').textContent = primary;
        }

        // Export to CSV
        function exportData() {
            if (cases.length === 0) {
                alert('No cases to export');
                return;
            }

            const headers = [
                'Date', 'Start Time', 'Duration (mins)', 'Procedure', 'Hospital',
                'Patient Name', 'Patient ID', 'Age', 'Sex', 'Surgeon Role', 'Complications'
            ];

            const customFieldNames = customFields.map(f => f.name);
            const allHeaders = [...headers, ...customFieldNames];

            const rows = cases.map(c => {
                const baseData = [
                    c.date,
                    c.startTime,
                    c.duration,
                    c.procedureName,
                    c.hospital || '',
                    c.patientName || '',
                    c.patientId || '',
                    c.patientAge || '',
                    c.patientSex || '',
                    c.surgeonRole,
                    c.complications || ''
                ];

                const customData = customFieldNames.map(name => c.customFields?.[name] || '');
                return [...baseData, ...customData];
            });

            let csv = allHeaders.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ot-logbook-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Export all data (JSON backup)
        function exportAllData() {
            const backup = {
                cases: cases,
                customFields: customFields,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(backup, null, 2);
            downloadFile(json, `ot-logbook-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            alert('‚úÖ Complete backup downloaded!');
        }

        // Import data
        function importData() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (confirm('This will replace your current data. Continue?')) {
                        cases = backup.cases || [];
                        customFields = backup.customFields || [];
                        await saveData();
                        
                        renderCases();
                        renderCustomFields();
                        renderCustomFieldInputs();
                        updateStats();
                        
                        alert('‚úÖ Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            this.value = '';
        });

        // Helper function to download files
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Clear all data
        async function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL cases and custom fields. This cannot be undone. Are you sure?')) {
                if (confirm('Final confirmation: Delete everything?')) {
                    cases = [];
                    customFields = [];
                    await saveData();
                    renderCases();
                    renderCustomFields();
                    renderCustomFieldInputs();
                    updateStats();
                    alert('All data cleared');
                }
            }
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderCases);
        document.getElementById('filterRole').addEventListener('change', renderCases);
        document.getElementById('filterDate').addEventListener('change', renderCases);

        // Close modal on background click
        document.getElementById('caseModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Initialize app
        init();
    </script>
</body>
</html>
