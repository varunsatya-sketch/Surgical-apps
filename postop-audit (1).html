<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Post-Op Audit">
    <meta name="theme-color" content="#f5576c">
    <title>Post-Op Audit</title>
    
    <!-- App Icon for Home Screen -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23f093fb;stop-opacity:1'/><stop offset='100%25' style='stop-color:%23f5576c;stop-opacity:1'/></linearGradient></defs><rect width='180' height='180' fill='url(%23grad)'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='90' fill='white'>üìä</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #f5576c;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat {
            background: #fff5f7;
            padding: 12px 16px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-subtext {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 2px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #f5576c;
        }

        .content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #f5576c;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #f5576c;
            color: white;
        }

        .btn-primary:hover {
            background: #e04858;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245,87,108,0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .patient-list {
            margin-top: 20px;
        }

        .patient-item {
            background: #fff5f7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #f5576c;
        }

        .patient-item:hover {
            background: #ffe5e9;
            transform: translateX(4px);
        }

        .patient-item.has-complication {
            border-left-color: #e53e3e;
            background: #fff5f5;
        }

        .patient-item.discharged {
            border-left-color: #38a169;
            background: #f0fff4;
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .patient-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .patient-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-active {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-discharged {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-complication {
            background: #fed7d7;
            color: #742a2a;
        }

        .patient-details {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
        }

        .patient-detail-row {
            margin-bottom: 4px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #fff5f7;
            border-radius: 8px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .alert-box {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .alert-box strong {
            color: #742a2a;
        }

        .success-box {
            background: #c6f6d5;
            border-left: 4px solid #38a169;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .info-section {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .info-value {
            color: #2d3748;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add {
            background: #48bb78;
            color: white;
        }

        .btn-remove {
            background: #f56565;
            color: white;
        }

        .custom-field-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .custom-field-item input {
            flex: 1;
        }

        @media (max-width: 640px) {
            .form-row,
            .form-row-3,
            .filter-row {
                grid-template-columns: 1fr;
            }

            .header .stats {
                grid-template-columns: 1fr;
            }
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .complication-tag {
            background: #fed7d7;
            color: #742a2a;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 4px;
            display: inline-block;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Post-Op Audit</h1>
            <p style="color: #718096; margin-top: 4px;">Patient Outcomes & Morbidity Tracking</p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Active Patients</div>
                    <div class="stat-value" id="activePatients">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Complications</div>
                    <div class="stat-value" id="totalComplications">0</div>
                    <div class="stat-subtext" id="complicationRate">0% rate</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Avg. LOS</div>
                    <div class="stat-value" id="avgLOS">0</div>
                    <div class="stat-subtext">days</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Readmissions</div>
                    <div class="stat-value" id="readmissions">0</div>
                    <div class="stat-subtext">within 30d</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">Add Patient</button>
            <button class="tab" onclick="switchTab('view')">View Patients</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Add Patient Tab -->
        <div class="content" id="addTab">
            <h2 style="margin-bottom: 20px; color: #2d3748;">New Post-Operative Patient</h2>
            <form id="patientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Patient Name</label>
                        <input type="text" id="patientName" placeholder="Patient's name (optional)">
                    </div>
                    <div class="form-group">
                        <label>Patient ID *</label>
                        <input type="text" id="patientId" placeholder="Hospital ID" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Surgery Date *</label>
                        <input type="date" id="surgeryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Patient Age</label>
                        <input type="number" id="age" min="0" max="120">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Hospital *</label>
                        <select id="hospital" required onchange="toggleOtherHospitalPostOp()">
                            <option value="">Select Hospital</option>
                            <option value="MH">MH</option>
                            <option value="MTH">MTH</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="otherHospitalGroup" style="display: none;">
                        <label>Hospital Name</label>
                        <input type="text" id="otherHospital" placeholder="Enter hospital name">
                    </div>
                </div>

                <div class="form-group">
                    <label>Procedure *</label>
                    <input type="text" id="procedure" placeholder="e.g., Total Hip Replacement" required>
                </div>

                <div class="form-group">
                    <label>Diagnosis</label>
                    <input type="text" id="diagnosis" placeholder="e.g., Osteoarthritis, Carcinoma, etc.">
                </div>

                <div class="form-group">
                    <label>Complications / Adverse Events</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-wound" value="Wound Infection">
                            <label for="comp-wound">Wound Infection</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-bleeding" value="Post-op Bleeding">
                            <label for="comp-bleeding">Post-operative Bleeding</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-pneumonia" value="Pneumonia">
                            <label for="comp-pneumonia">Pneumonia</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-dvt" value="DVT/PE">
                            <label for="comp-dvt">DVT/Pulmonary Embolism</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-sepsis" value="Sepsis">
                            <label for="comp-sepsis">Sepsis</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-leak" value="Anastomotic Leak">
                            <label for="comp-leak">Anastomotic Leak</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-flap-partial" value="Flap Loss - Partial">
                            <label for="comp-flap-partial">Flap Loss - Partial</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-flap-total" value="Flap Loss - Total">
                            <label for="comp-flap-total">Flap Loss - Total</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-fistula" value="OC Fistula">
                            <label for="comp-fistula">Orocutaneous Fistula</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-cardiac" value="Cardiac Event">
                            <label for="comp-cardiac">Cardiac Event</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="comp-other" value="Other">
                            <label for="comp-other">Other (specify below)</label>
                        </div>
                    </div>
                    <textarea id="complicationNotes" placeholder="Additional complication details..." style="margin-top: 12px;"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Wound Status at Discharge</label>
                        <select id="woundStatus">
                            <option value="">Select</option>
                            <option value="Clean, healing well">Clean, healing well</option>
                            <option value="Minor inflammation">Minor inflammation</option>
                            <option value="Infection">Infection</option>
                            <option value="Dehiscence">Dehiscence</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Discharge Date</label>
                        <input type="date" id="dischargeDate" onchange="calculateLOS()">
                        <p id="losDisplay" style="font-size: 13px; color: #667eea; margin-top: 8px; font-weight: 600;"></p>
                    </div>
                </div>

                <div class="form-row">
                        <label>Readmitted within 30 days?</label>
                        <select id="readmission">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="readmissionDetails" style="display: none;">
                    <label>Readmission Details</label>
                    <textarea id="readmissionNotes" placeholder="Reason for readmission..."></textarea>
                </div>

                <div class="custom-fields" id="customAuditFields" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
                    <h3 style="margin-bottom: 16px; color: #2d3748;">Custom Audit Criteria</h3>
                    <div id="customAuditInputs"></div>
                </div>

                <button type="submit" class="btn btn-primary">Save Patient Record</button>
            </form>
        </div>

        <!-- View Patients Tab -->
        <div class="content" id="viewTab" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Patient Records</h2>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search by patient ID, procedure, or notes...">
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Filter by Status</label>
                        <select id="filterStatus">
                            <option value="">All Patients</option>
                            <option value="active">Active (Not Discharged)</option>
                            <option value="discharged">Discharged</option>
                            <option value="complications">With Complications</option>
                            <option value="readmitted">Readmitted</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Date Range</label>
                        <select id="filterDate">
                            <option value="">All Time</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                            <option value="3months">Last 3 Months</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="patient-list" id="patientList"></div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <h3 style="margin-bottom: 16px; color: #2d3748;">Export Data for Analysis</h3>
                <button class="btn btn-secondary" onclick="exportCSV()" style="background: #48bb78; color: white; margin-bottom: 12px;">üìä Export to CSV (Excel Compatible)</button>
                <button class="btn btn-secondary" onclick="exportSPSS()" style="background: #4299e1; color: white;">üìà Export to SPSS Format (.csv)</button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="content" id="settingsTab" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Settings</h2>
            
            <div style="background: #fff5f7; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="color: #2d3748; margin-bottom: 12px;">üë§ User Identity</h3>
                <p style="color: #4a5568; margin-bottom: 12px;">
                    <strong>Current User:</strong> <span id="currentUserDisplay" style="color: #f5576c;"></span>
                </p>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-small" onclick="changeUsername()" style="background: #f5576c; color: white;">Change Username</button>
                    <button class="btn-small" id="adminToggleBtn" onclick="toggleAdmin()" style="background: #9f7aea; color: white;">üîê Login as Admin</button>
                </div>
                <p style="margin-top: 12px; font-size: 13px; color: #718096;">
                    <strong>Admin mode</strong> allows you to see edit history and who created each entry.
                </p>
            </div>

            <div style="background: #fff5f7; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="color: #2d3748; margin-bottom: 12px;">‚òÅÔ∏è Cloud Backup</h3>
                <p style="color: #4a5568; margin-bottom: 16px; line-height: 1.6;">
                    Your data is automatically backed up online. You can access it from any device by opening this app.
                    Data is private and stored securely.
                </p>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-small" onclick="manualBackup()" style="background: #4299e1; color: white; flex: 1;">üíæ Backup Now</button>
                    <button class="btn-small" onclick="restoreFromBackup()" style="background: #9f7aea; color: white; flex: 1;">üîÑ Restore Data</button>
                </div>
                <p id="backupStatus" style="margin-top: 12px; font-size: 13px; color: #718096;"></p>
            </div>

            <div style="margin-bottom: 24px;">
                <h3 style="color: #2d3748; margin-bottom: 12px;">Custom Audit Criteria</h3>
                <p style="color: #718096; margin-bottom: 16px;">Add custom fields to track specific audit criteria for your department.</p>
                
                <div id="customAuditList"></div>

                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <input type="text" id="newAuditField" placeholder="Field name (e.g., ICU Admission Required)" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <button class="btn-small btn-add" onclick="addCustomAudit()">+ Add Field</button>
                </div>
            </div>

            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <h3 style="color: #2d3748; margin-bottom: 12px;">Data Management</h3>
                <button class="btn btn-secondary" onclick="exportAllData()" style="background: #4299e1; color: white; margin-bottom: 12px;">üíæ Download Complete Backup (JSON)</button>
                <button class="btn btn-secondary" onclick="importData()" style="background: #9f7aea; color: white; margin-bottom: 12px;">üì§ Import Data from File</button>
                <button class="btn btn-secondary" onclick="clearAllData()" style="background: #fed7d7; color: #742a2a;">üóëÔ∏è Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Patient Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="editPatient()" style="flex: 1; background: #4299e1; color: white;">‚úèÔ∏è Edit</button>
                <button class="btn btn-secondary" onclick="deletePatient()" style="flex: 1; background: #fed7d7; color: #742a2a;">Delete</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        let patients = [];
        let customAuditFields = [];
        let currentPatientId = null;
        let editMode = false;
        let editingPatientId = null;
        let currentUser = '';
        let isAdmin = false;
        const ADMIN_PASSWORD = 'admin123'; // Change this to your secure password

        // Initialize
        async function init() {
            // Get user identity
            await getUserIdentity();
            
            await loadData();
            renderCustomAuditInputs();
            renderCustomAuditList();
            renderPatients();
            updateStats();
            
            // Set today's date as default
            document.getElementById('surgeryDate').valueAsDate = new Date();

            // Show last backup time
            showBackupStatus();
        }

        // Toggle other hospital input
        function toggleOtherHospitalPostOp() {
            const hospitalSelect = document.getElementById('hospital');
            const otherGroup = document.getElementById('otherHospitalGroup');
            const otherInput = document.getElementById('otherHospital');
            
            if (hospitalSelect.value === 'Other') {
                otherGroup.style.display = 'block';
                otherInput.required = true;
            } else {
                otherGroup.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        // Calculate Length of Stay (excluding surgery date)
        function calculateLOS() {
            const surgeryDate = document.getElementById('surgeryDate').value;
            const dischargeDate = document.getElementById('dischargeDate').value;
            const losDisplay = document.getElementById('losDisplay');
            
            if (surgeryDate && dischargeDate) {
                const surgery = new Date(surgeryDate);
                const discharge = new Date(dischargeDate);
                
                // Calculate difference in days (excluding surgery date)
                const diffTime = discharge - surgery;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    losDisplay.textContent = '‚ö†Ô∏è Discharge date must be after surgery date';
                    losDisplay.style.color = '#e53e3e';
                } else if (diffDays === 0) {
                    losDisplay.textContent = '‚úì Length of Stay: Same day discharge (0 days)';
                    losDisplay.style.color = '#48bb78';
                } else {
                    losDisplay.textContent = `‚úì Length of Stay: ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
                    losDisplay.style.color = '#667eea';
                }
            } else {
                losDisplay.textContent = '';
            }
        }

        // Also trigger LOS calculation when surgery date changes
        document.addEventListener('DOMContentLoaded', function() {
            const surgeryDateInput = document.getElementById('surgeryDate');
            if (surgeryDateInput) {
                surgeryDateInput.addEventListener('change', calculateLOS);
            }
        });

        // Get or set user identity
        async function getUserIdentity() {
            try {
                const result = await window.storage.get('current-user-postop', true);
                if (result && result.value) {
                    currentUser = result.value;
                } else {
                    const name = prompt('Please enter your name (for tracking who makes entries):');
                    if (name && name.trim()) {
                        currentUser = name.trim();
                        await window.storage.set('current-user-postop', currentUser, true);
                    } else {
                        currentUser = 'Unknown User';
                    }
                }
                
                // Check if admin
                try {
                    const adminResult = await window.storage.get('is-admin-postop', false);
                    isAdmin = adminResult && adminResult.value === 'true';
                } catch (e) {
                    isAdmin = false;
                }
                
                // Display current user in settings
                const display = document.getElementById('currentUserDisplay');
                if (display) {
                    display.textContent = currentUser + (isAdmin ? ' (Admin)' : '');
                }
            } catch (e) {
                currentUser = 'Unknown User';
                isAdmin = false;
            }
        }

        // Toggle admin mode
        async function toggleAdmin() {
            if (isAdmin) {
                // Logout from admin
                if (confirm('Logout from admin mode?')) {
                    isAdmin = false;
                    await window.storage.set('is-admin-postop', 'false', false);
                    document.getElementById('currentUserDisplay').textContent = currentUser;
                    document.getElementById('adminToggleBtn').textContent = 'üîê Login as Admin';
                    alert('‚úÖ Logged out from admin mode');
                }
            } else {
                // Login as admin
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    await window.storage.set('is-admin-postop', 'true', false);
                    document.getElementById('currentUserDisplay').textContent = currentUser + ' (Admin)';
                    document.getElementById('adminToggleBtn').textContent = 'üîì Logout from Admin';
                    alert('‚úÖ Admin access granted! You can now see edit history and user details.');
                } else if (password !== null) {
                    alert('‚ùå Incorrect password');
                }
            }
        }

        // Change username
        async function changeUsername() {
            const newName = prompt('Enter new username:', currentUser);
            if (newName && newName.trim() && newName.trim() !== currentUser) {
                currentUser = newName.trim();
                await window.storage.set('current-user-postop', currentUser, true);
                document.getElementById('currentUserDisplay').textContent = currentUser;
                alert('‚úÖ Username updated to: ' + currentUser);
            }
        }

        // Load data from storage
        async function loadData() {
            try {
                const patientsResult = await window.storage.get('postop-patients', true); // Changed to shared=true
                if (patientsResult) {
                    patients = JSON.parse(patientsResult.value);
                }
            } catch (e) {
                patients = [];
            }

            try {
                const auditResult = await window.storage.get('custom-audit-fields', true); // Changed to shared=true
                if (auditResult) {
                    customAuditFields = JSON.parse(auditResult.value);
                }
            } catch (e) {
                customAuditFields = [];
            }
        }

        // Save data to storage
        async function saveData() {
            try {
                await window.storage.set('postop-patients', JSON.stringify(patients), true); // Changed to shared=true
                await window.storage.set('custom-audit-fields', JSON.stringify(customAuditFields), true); // Changed to shared=true
                await window.storage.set('last-backup', new Date().toISOString(), true); // Changed to shared=true
                showBackupStatus();
            } catch (e) {
                alert('Error saving data: ' + e.message);
            }
        }

        // Manual backup
        async function manualBackup() {
            await saveData();
            alert('‚úÖ Data backed up successfully!');
        }

        // Restore from backup
        async function restoreFromBackup() {
            if (confirm('This will replace your current data with the backed up version. Continue?')) {
                await loadData();
                renderPatients();
                renderCustomAuditList();
                renderCustomAuditInputs();
                updateStats();
                alert('‚úÖ Data restored from backup!');
            }
        }

        // Show backup status
        async function showBackupStatus() {
            try {
                const result = await window.storage.get('last-backup', true); // Changed to shared=true
                if (result) {
                    const date = new Date(result.value);
                    document.getElementById('backupStatus').textContent = 
                        `Last backup: ${date.toLocaleString()}`;
                }
            } catch (e) {
                document.getElementById('backupStatus').textContent = 'No backup found';
            }
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.style.display = 'none');

            if (tab === 'add') {
                event.target.classList.add('active');
                document.getElementById('addTab').style.display = 'block';
            } else if (tab === 'view') {
                event.target.classList.add('active');
                document.getElementById('viewTab').style.display = 'block';
                renderPatients();
            } else if (tab === 'settings') {
                event.target.classList.add('active');
                document.getElementById('settingsTab').style.display = 'block';
                renderCustomAuditList();
                // Update username display
                const display = document.getElementById('currentUserDisplay');
                if (display) display.textContent = currentUser + (isAdmin ? ' (Admin)' : '');
                // Update button text
                const btn = document.getElementById('adminToggleBtn');
                if (btn) btn.textContent = isAdmin ? 'üîì Logout from Admin' : 'üîê Login as Admin';
            }
        }

        // Handle form submission
        document.getElementById('patientForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get selected complications
            const complications = [];
            document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked').forEach(cb => {
                complications.push(cb.value);
            });

            // Get custom audit data
            const customData = {};
            customAuditFields.forEach(field => {
                const input = document.getElementById(`audit-${field.id}`);
                if (input) {
                    customData[field.name] = input.value;
                }
            });

            const now = new Date().toISOString();
            let editHistory = [];
            
            if (editMode) {
                const existingPatient = patients.find(p => p.id === editingPatientId);
                editHistory = existingPatient.editHistory || [];
                editHistory.push({
                    editedBy: currentUser,
                    editedAt: now,
                    action: 'Updated'
                });
            }

            // Determine hospital name
            const hospitalValue = document.getElementById('hospital').value;
            const hospitalName = hospitalValue === 'Other' 
                ? document.getElementById('otherHospital').value 
                : hospitalValue;

            // Calculate Length of Stay
            let lengthOfStay = null;
            const surgeryDate = document.getElementById('surgeryDate').value;
            const dischargeDate = document.getElementById('dischargeDate').value;
            if (surgeryDate && dischargeDate) {
                const surgery = new Date(surgeryDate);
                const discharge = new Date(dischargeDate);
                const diffTime = discharge - surgery;
                lengthOfStay = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            const patientData = {
                id: editMode ? editingPatientId : Date.now(),
                patientName: document.getElementById('patientName').value,
                patientId: document.getElementById('patientId').value,
                surgeryDate: surgeryDate,
                hospital: hospitalName,
                procedure: document.getElementById('procedure').value,
                diagnosis: document.getElementById('diagnosis').value,
                age: document.getElementById('age').value,
                complications: complications,
                complicationNotes: document.getElementById('complicationNotes').value,
                woundStatus: document.getElementById('woundStatus').value,
                lengthOfStay: lengthOfStay,
                dischargeDate: dischargeDate,
                readmission: document.getElementById('readmission').value,
                readmissionNotes: document.getElementById('readmissionNotes').value,
                customAudit: customData,
                createdAt: editMode ? patients.find(p => p.id === editingPatientId).createdAt : now,
                createdBy: editMode ? patients.find(p => p.id === editingPatientId).createdBy : currentUser,
                lastModified: now,
                lastModifiedBy: currentUser,
                editHistory: editHistory
            };

            if (editMode) {
                // Update existing patient
                const index = patients.findIndex(p => p.id === editingPatientId);
                patients[index] = patientData;
                editMode = false;
                editingPatientId = null;
                document.querySelector('#addTab h2').textContent = 'New Post-Operative Patient';
            } else {
                // Add new patient
                patients.unshift(patientData);
            }
            
            await saveData();

            // Reset form
            this.reset();
            document.getElementById('surgeryDate').valueAsDate = new Date();
            document.getElementById('readmissionDetails').style.display = 'none';
            renderCustomAuditInputs();

            updateStats();
            alert(editMode ? '‚úÖ Patient updated successfully!' : '‚úÖ Patient record saved successfully!');
            
            // Switch to view tab
            switchTab('view');
        });

        // Show/hide readmission details
        document.getElementById('readmission').addEventListener('change', function() {
            document.getElementById('readmissionDetails').style.display = 
                this.value === 'Yes' ? 'block' : 'none';
        });

        // Render custom audit inputs in form
        function renderCustomAuditInputs() {
            const container = document.getElementById('customAuditInputs');
            if (customAuditFields.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-style: italic;">No custom audit criteria configured. Add them in Settings.</p>';
                return;
            }

            container.innerHTML = customAuditFields.map(field => `
                <div class="form-group">
                    <label>${field.name}</label>
                    <input type="text" id="audit-${field.id}" placeholder="Enter ${field.name}">
                </div>
            `).join('');
        }

        // Render patients list
        function renderPatients() {
            const container = document.getElementById('patientList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterDate = document.getElementById('filterDate').value;

            let filtered = patients.filter(p => {
                const matchesSearch = !searchTerm || 
                    p.patientId.toLowerCase().includes(searchTerm) ||
                    p.procedure.toLowerCase().includes(searchTerm) ||
                    p.complicationNotes.toLowerCase().includes(searchTerm);

                let matchesStatus = true;
                if (filterStatus === 'active') {
                    matchesStatus = !p.dischargeDate;
                } else if (filterStatus === 'discharged') {
                    matchesStatus = !!p.dischargeDate;
                } else if (filterStatus === 'complications') {
                    matchesStatus = p.complications.length > 0;
                } else if (filterStatus === 'readmitted') {
                    matchesStatus = p.readmission === 'Yes';
                }

                let matchesDate = true;
                if (filterDate) {
                    const surgeryDate = new Date(p.surgeryDate);
                    const now = new Date();
                    
                    if (filterDate === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchesDate = surgeryDate >= weekAgo;
                    } else if (filterDate === 'month') {
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        matchesDate = surgeryDate >= monthAgo;
                    } else if (filterDate === '3months') {
                        const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        matchesDate = surgeryDate >= threeMonthsAgo;
                    } else if (filterDate === 'year') {
                        matchesDate = surgeryDate.getFullYear() === now.getFullYear();
                    }
                }

                return matchesSearch && matchesStatus && matchesDate;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No patient records found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(p => {
                const hasComplications = p.complications.length > 0;
                const isDischarged = !!p.dischargeDate;
                const isReadmitted = p.readmission === 'Yes';
                
                let itemClass = 'patient-item';
                let statusClass = 'status-active';
                let statusText = 'Active';
                
                if (isDischarged) {
                    itemClass += ' discharged';
                    statusClass = 'status-discharged';
                    statusText = 'Discharged';
                }
                if (hasComplications) {
                    itemClass += ' has-complication';
                    statusClass = 'status-complication';
                    statusText = 'Complication';
                }
                
                return `
                    <div class="${itemClass}" onclick="showPatientDetails(${p.id})">
                        <div class="patient-header">
                            <div class="patient-name">${p.patientName || 'Patient ' + p.patientId} - ${p.procedure}</div>
                            <div class="patient-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="patient-details">
                            <div class="patient-detail-row">
                                ${p.patientName ? `<strong>ID:</strong> ${p.patientId} | ` : ''}
                                <strong>Surgery Date:</strong> ${formatDate(p.surgeryDate)} | 
                                ${p.age ? `<strong>Age:</strong> ${p.age}` : ''}
                            </div>
                            ${p.lengthOfStay ? `
                                <div class="patient-detail-row">
                                    <strong>Length of Stay:</strong> ${p.lengthOfStay} days
                                </div>
                            ` : ''}
                            ${hasComplications ? `
                                <div class="patient-detail-row">
                                    ${p.complications.map(c => `<span class="complication-tag">${c}</span>`).join('')}
                                </div>
                            ` : ''}
                            ${isReadmitted ? `
                                <div class="patient-detail-row">
                                    <span class="complication-tag">‚ö†Ô∏è Readmitted</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show patient details modal
        function showPatientDetails(patientId) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            const hasComplications = patient.complications.length > 0;
            const customAuditHtml = Object.keys(patient.customAudit || {}).length > 0 
                ? `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h3 style="margin-bottom: 12px; color: #2d3748;">Custom Audit Criteria</h3>
                        <div class="info-section">
                            ${Object.entries(patient.customAudit).map(([key, value]) => `
                                <div class="info-row">
                                    <span class="info-label">${key}:</span>
                                    <span class="info-value">${value || 'N/A'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `
                : '';

            const editHistoryHtml = isAdmin && patient.editHistory && patient.editHistory.length > 0
                ? `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h3 style="margin-bottom: 12px; color: #2d3748;">üìú Edit History (Admin Only)</h3>
                        ${patient.editHistory.map(edit => `
                            <div style="font-size: 13px; color: #4a5568; margin-bottom: 6px;">
                                ${edit.action} by <strong>${edit.editedBy}</strong> on ${new Date(edit.editedAt).toLocaleString()}
                            </div>
                        `).join('')}
                    </div>
                `
                : '';

            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #f5576c; margin-bottom: 8px;">${patient.patientName || 'Patient ' + patient.patientId}</h3>
                    <p style="color: #718096;">${patient.procedure}</p>
                    ${isAdmin && patient.createdBy ? `<p style="color: #718096; font-size: 13px; margin-top: 4px;">Created by ${patient.createdBy}</p>` : ''}
                </div>

                ${hasComplications ? `
                    <div class="alert-box">
                        <strong>‚ö†Ô∏è Complications Recorded</strong>
                    </div>
                ` : ''}

                ${patient.readmission === 'Yes' ? `
                    <div class="alert-box">
                        <strong>‚ö†Ô∏è Patient Readmitted within 30 days</strong>
                    </div>
                ` : ''}

                <div class="info-section">
                    ${patient.diagnosis ? `
                        <div class="info-row">
                            <span class="info-label">Diagnosis:</span>
                            <span class="info-value">${patient.diagnosis}</span>
                        </div>
                    ` : ''}
                    ${patient.patientName ? `
                        <div class="info-row">
                            <span class="info-label">Patient ID:</span>
                            <span class="info-value">${patient.patientId}</span>
                        </div>
                    ` : ''}
                    <div class="info-row">
                        <span class="info-label">Surgery Date:</span>
                        <span class="info-value">${formatDate(patient.surgeryDate)}</span>
                    </div>
                    ${patient.age ? `
                        <div class="info-row">
                            <span class="info-label">Age:</span>
                            <span class="info-value">${patient.age}</span>
                        </div>
                    ` : ''}
                    ${patient.dischargeDate ? `
                        <div class="info-row">
                            <span class="info-label">Discharge Date:</span>
                            <span class="info-value">${formatDate(patient.dischargeDate)}</span>
                        </div>
                    ` : ''}
                    ${patient.lengthOfStay ? `
                        <div class="info-row">
                            <span class="info-label">Length of Stay:</span>
                            <span class="info-value">${patient.lengthOfStay} days</span>
                        </div>
                    ` : ''}
                    ${patient.woundStatus ? `
                        <div class="info-row">
                            <span class="info-label">Wound Status at Discharge:</span>
                            <span class="info-value">${patient.woundStatus}</span>
                        </div>
                    ` : ''}
                </div>

                ${hasComplications ? `
                    <div style="margin-top: 16px;">
                        <strong style="color: #2d3748;">Complications:</strong>
                        <div style="margin-top: 8px;">
                            ${patient.complications.map(c => `<span class="complication-tag">${c}</span>`).join('')}
                        </div>
                        ${patient.complicationNotes ? `
                            <p style="margin-top: 12px; color: #4a5568; line-height: 1.6;">${patient.complicationNotes}</p>
                        ` : ''}
                    </div>
                ` : ''}

                ${patient.readmission === 'Yes' && patient.readmissionNotes ? `
                    <div style="margin-top: 16px;">
                        <strong style="color: #2d3748;">Readmission Details:</strong>
                        <p style="margin-top: 8px; color: #4a5568; line-height: 1.6;">${patient.readmissionNotes}</p>
                    </div>
                ` : ''}

                ${customAuditHtml}
                ${editHistoryHtml}
            `;

            document.getElementById('patientModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('patientModal').classList.remove('active');
            currentPatientId = null;
        }

        function editPatient() {
            if (!currentPatientId) return;
            
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) return;

            // Enter edit mode
            editMode = true;
            editingPatientId = currentPatientId;

            // Populate form
            document.getElementById('patientName').value = patient.patientName || '';
            document.getElementById('patientId').value = patient.patientId;
            document.getElementById('surgeryDate').value = patient.surgeryDate;
            
            // Set hospital
            const isCustomHospital = patient.hospital && !['MH', 'MTH'].includes(patient.hospital);
            if (isCustomHospital) {
                document.getElementById('hospital').value = 'Other';
                document.getElementById('otherHospital').value = patient.hospital;
                toggleOtherHospitalPostOp();
            } else {
                document.getElementById('hospital').value = patient.hospital || '';
            }
            
            document.getElementById('procedure').value = patient.procedure;
            document.getElementById('diagnosis').value = patient.diagnosis || '';
            document.getElementById('age').value = patient.age || '';
            document.getElementById('complicationNotes').value = patient.complicationNotes || '';
            document.getElementById('woundStatus').value = patient.woundStatus || '';
            document.getElementById('dischargeDate').value = patient.dischargeDate || '';
            
            // Calculate and display LOS
            calculateLOS();
            
            document.getElementById('readmission').value = patient.readmission;
            document.getElementById('readmissionNotes').value = patient.readmissionNotes || '';

            // Set complications checkboxes
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = patient.complications.includes(cb.value);
            });

            // Show/hide readmission details
            document.getElementById('readmissionDetails').style.display = 
                patient.readmission === 'Yes' ? 'block' : 'none';

            // Populate custom fields
            customAuditFields.forEach(field => {
                const input = document.getElementById(`audit-${field.id}`);
                if (input && patient.customAudit) {
                    input.value = patient.customAudit[field.name] || '';
                }
            });

            // Update form title
            document.querySelector('#addTab h2').textContent = 'Edit Patient Record';

            // Close modal and switch to add tab
            closeModal();
            switchTab('add');
        }

        async function deletePatient() {
            if (!currentPatientId) return;
            
            if (confirm('Are you sure you want to delete this patient record? This cannot be undone.')) {
                patients = patients.filter(p => p.id !== currentPatientId);
                await saveData();
                closeModal();
                renderPatients();
                updateStats();
            }
        }

        // Custom audit fields management
        function renderCustomAuditList() {
            const container = document.getElementById('customAuditList');
            
            if (customAuditFields.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-style: italic;">No custom audit criteria added yet.</p>';
                return;
            }

            container.innerHTML = customAuditFields.map(field => `
                <div class="custom-field-item">
                    <input type="text" value="${field.name}" readonly style="background: #f7fafc;">
                    <button class="btn-small btn-remove" onclick="removeCustomAudit(${field.id})">Remove</button>
                </div>
            `).join('');
        }

        async function addCustomAudit() {
            const fieldName = document.getElementById('newAuditField').value.trim();
            if (!fieldName) {
                alert('Please enter a field name');
                return;
            }

            customAuditFields.push({
                id: Date.now(),
                name: fieldName
            });

            await saveData();
            document.getElementById('newAuditField').value = '';
            renderCustomAuditList();
            renderCustomAuditInputs();
        }

        async function removeCustomAudit(fieldId) {
            if (confirm('Remove this audit criterion? Data in existing records will be preserved.')) {
                customAuditFields = customAuditFields.filter(f => f.id !== fieldId);
                await saveData();
                renderCustomAuditList();
                renderCustomAuditInputs();
            }
        }

        // Statistics
        function updateStats() {
            const active = patients.filter(p => !p.dischargeDate).length;
            const withComplications = patients.filter(p => p.complications.length > 0).length;
            const complicationRate = patients.length > 0 
                ? ((withComplications / patients.length) * 100).toFixed(1) 
                : 0;
            
            const patientsWithLOS = patients.filter(p => p.lengthOfStay);
            const avgLOS = patientsWithLOS.length > 0 
                ? (patientsWithLOS.reduce((sum, p) => sum + p.lengthOfStay, 0) / patientsWithLOS.length).toFixed(1)
                : 0;
            
            const readmitted = patients.filter(p => p.readmission === 'Yes').length;

            document.getElementById('activePatients').textContent = active;
            document.getElementById('totalComplications').textContent = withComplications;
            document.getElementById('complicationRate').textContent = `${complicationRate}% rate`;
            document.getElementById('avgLOS').textContent = avgLOS;
            document.getElementById('readmissions').textContent = readmitted;
        }

        // Export to CSV (Excel compatible)
        function exportCSV() {
            if (patients.length === 0) {
                alert('No patient records to export');
                return;
            }

            const headers = [
                'Patient Name', 'Patient ID', 'Surgery Date', 'Procedure', 'Age', 
                'Complications', 'Complication Details', 'Wound Status',
                'Length of Stay', 'Discharge Date', 'Readmission', 'Readmission Details'
            ];

            const customAuditNames = customAuditFields.map(f => f.name);
            const allHeaders = [...headers, ...customAuditNames];

            const rows = patients.map(p => {
                const baseData = [
                    p.patientName || '',
                    p.patientId,
                    p.surgeryDate,
                    p.procedure,
                    p.age || '',
                    p.complications.join('; '),
                    p.complicationNotes || '',
                    p.woundStatus || '',
                    p.lengthOfStay || '',
                    p.dischargeDate || '',
                    p.readmission,
                    p.readmissionNotes || ''
                ];

                const customData = customAuditNames.map(name => p.customAudit?.[name] || '');
                return [...baseData, ...customData];
            });

            let csv = allHeaders.map(h => `"${h}"`).join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            downloadFile(csv, `postop-audit-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            alert('‚úÖ Data exported successfully! File is ready for Excel or any spreadsheet software.');
        }

        // Export to SPSS format
        function exportSPSS() {
            if (patients.length === 0) {
                alert('No patient records to export');
                return;
            }

            // Create coded variables for SPSS
            const headers = [
                'PatientName', 'PatientID', 'SurgeryDate', 'Procedure', 'Age', 
                'HasComplications', 'WoundInfection', 'Bleeding', 'Pneumonia', 
                'DVT_PE', 'Sepsis', 'OtherComplication',
                'WoundStatus_Code', 'LengthOfStay', 'DischargeDate', 
                'Readmitted_Code'
            ];

            const customAuditNames = customAuditFields.map(f => f.name.replace(/\s+/g, '_'));
            const allHeaders = [...headers, ...customAuditNames];

            const rows = patients.map(p => {
                // Code wound status
                const woundCodes = {
                    'Clean, healing well': 1,
                    'Minor inflammation': 2,
                    'Infection': 3,
                    'Dehiscence': 4,
                    'Other': 5
                };

                const baseData = [
                    p.patientName || '',
                    p.patientId,
                    p.surgeryDate,
                    p.procedure,
                    p.age || '',
                    p.complications.length > 0 ? 1 : 0,
                    p.complications.includes('Wound Infection') ? 1 : 0,
                    p.complications.includes('Post-op Bleeding') ? 1 : 0,
                    p.complications.includes('Pneumonia') ? 1 : 0,
                    p.complications.includes('DVT/PE') ? 1 : 0,
                    p.complications.includes('Sepsis') ? 1 : 0,
                    p.complications.includes('Other') ? 1 : 0,
                    woundCodes[p.woundStatus] || '',
                    p.lengthOfStay || '',
                    p.dischargeDate || '',
                    p.readmission === 'Yes' ? 1 : 0
                ];

                const customData = customAuditNames.map(name => {
                    const originalName = customAuditFields.find(f => f.name.replace(/\s+/g, '_') === name)?.name;
                    return p.customAudit?.[originalName] || '';
                });
                return [...baseData, ...customData];
            });

            let csv = allHeaders.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            // Add SPSS variable coding comments
            csv += '\n\n# SPSS Variable Coding:\n';
            csv += '# HasComplications: 0=No, 1=Yes\n';
            csv += '# All complication variables: 0=No, 1=Yes\n';
            csv += '# WoundStatus_Code: 1=Clean/healing, 2=Minor inflammation, 3=Infection, 4=Dehiscence, 5=Other\n';
            csv += '# Readmitted_Code: 0=No, 1=Yes\n';

            downloadFile(csv, `postop-audit-spss-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            alert('‚úÖ SPSS-formatted data exported! Coded variables are ready for statistical analysis.');
        }

        // Export all data (JSON backup)
        function exportAllData() {
            const backup = {
                patients: patients,
                customAuditFields: customAuditFields,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(backup, null, 2);
            downloadFile(json, `postop-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            alert('‚úÖ Complete backup downloaded!');
        }

        // Import data
        function importData() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (confirm('This will replace your current data. Continue?')) {
                        patients = backup.patients || [];
                        customAuditFields = backup.customAuditFields || [];
                        await saveData();
                        
                        renderPatients();
                        renderCustomAuditList();
                        renderCustomAuditInputs();
                        updateStats();
                        
                        alert('‚úÖ Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            this.value = '';
        });

        // Clear all data
        async function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL patient records and audit criteria. This cannot be undone. Are you sure?')) {
                if (confirm('Final confirmation: Delete everything?')) {
                    patients = [];
                    customAuditFields = [];
                    await saveData();
                    renderPatients();
                    renderCustomAuditList();
                    renderCustomAuditInputs();
                    updateStats();
                    alert('All data cleared');
                }
            }
        }

        // Helper function to download files
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderPatients);
        document.getElementById('filterStatus').addEventListener('change', renderPatients);
        document.getElementById('filterDate').addEventListener('change', renderPatients);

        // Close modal on background click
        document.getElementById('patientModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Initialize app
        init();
    </script>
</body>
</html>